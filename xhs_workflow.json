{
  "name": "XHS Note Analysis Pipeline",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "promotion_target",
              "value": "å›½ä¼å¤®ä¼æ±‚èŒè¾…å¯¼å°ç¨‹åº"
            },
            {
              "name": "business_context",
              "value": "ä¸“æ³¨äºå›½ä¼å¤®ä¼æ±‚èŒåŸ¹è®­çš„æ•™è‚²æœºæ„"
            },
            {
              "name": "max_pages",
              "value": "5"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [280, 300],
      "name": "Set Input Parameters",
      "id": "node1"
    },
    {
      "parameters": {
        "command": "python3",
        "arguments": [
          "-c",
          "import sys\nsys.path.append('/Users/liuchao/AI/xhs_note_analyzer/xhs_note_analyzer/src')\nfrom xhs_note_analyzer.crews.hot_note_finder_crew.hot_note_finder_crew import HotNoteFinderCrew\nimport json\n\n# è·å–è¾“å…¥å‚æ•°\npromotion_target = '{{ $json.promotion_target }}'\nmax_pages = int('{{ $json.max_pages }}')\n\n# åˆ›å»ºHotNoteFinderCrew\ncrew = HotNoteFinderCrew()\n\n# æ‰§è¡Œç¬”è®°å‘ç°\nresult = crew.kickoff(inputs={\n    'promotion_target': promotion_target,\n    'max_pages': max_pages\n})\n\nprint(json.dumps(result, ensure_ascii=False))"
        ]
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [500, 300],
      "name": "Step 1: Find Hot Notes",
      "id": "node2"
    },
    {
      "parameters": {
        "jsCode": "// è§£æHotNoteFinderCrewçš„ç»“æœ\nconst result = JSON.parse($input.first().json.stdout);\n\nif (!result.success || !result.notes || result.notes.length === 0) {\n  throw new Error('æœªæ‰¾åˆ°ä»»ä½•ä¼˜è´¨ç¬”è®°');\n}\n\n// å‡†å¤‡MediaCrawlerçš„è¾“å…¥\nconst notes = result.notes.map(note => ({\n  note_title: note.note_title,\n  note_url: note.note_url,\n  impression: note.impression,\n  click: note.click,\n  like: note.like,\n  collect: note.collect,\n  comment: note.comment,\n  engage: note.engage\n}));\n\nreturn {\n  success: true,\n  notes: notes,\n  total_count: notes.length,\n  message: `æˆåŠŸæ‰¾åˆ° ${notes.length} æ¡ä¼˜è´¨ç¬”è®°`\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [720, 300],
      "name": "Parse Notes Result",
      "id": "node3"
    },
    {
      "parameters": {
        "command": "python3",
        "arguments": [
          "-c",
          "import sys\nsys.path.append('/Users/liuchao/AI/xhs_note_analyzer/xhs_note_analyzer/src')\nfrom xhs_note_analyzer.tools.mediacrawler_client import MediaCrawlerClient\nimport json\n\n# è·å–ç¬”è®°åˆ—è¡¨\nnotes_data = json.loads('''{{ $json }}''')\nnotes = notes_data.get('notes', [])\n\n# åˆ›å»ºMediaCrawlerå®¢æˆ·ç«¯\nclient = MediaCrawlerClient()\n\n# æ‰¹é‡é‡‡é›†ç¬”è®°è¯¦æƒ…\ndetailed_notes = []\nfor note in notes:\n    note_url = note.get('note_url', '')\n    if note_url:\n        # è°ƒç”¨APIè·å–è¯¦ç»†å†…å®¹\n        content_result = client.crawl_note(note_url, fetch_comments=False)\n        \n        if content_result.get('success', False):\n            detailed_note = {\n                'basic_info': note,\n                'content': content_result.get('data', {}).get('content', ''),\n                'images': content_result.get('data', {}).get('images', []),\n                'video_url': content_result.get('data', {}).get('video_url', ''),\n                'author_info': content_result.get('data', {}).get('author', {}),\n                'tags': content_result.get('data', {}).get('tags', []),\n                'create_time': content_result.get('data', {}).get('create_time', '')\n            }\n        else:\n            # å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®\n            detailed_note = {\n                'basic_info': note,\n                'content': f'è¿™æ˜¯{note.get(\"note_title\", \"\")}çš„è¯¦ç»†å†…å®¹...',\n                'images': ['https://example.com/image1.jpg'],\n                'video_url': '',\n                'author_info': {'name': 'ä½œè€…ç¤ºä¾‹', 'followers': 10000},\n                'tags': ['æ±‚èŒ', 'å›½ä¼', 'é¢è¯•'],\n                'create_time': '2024-01-01'\n            }\n        \n        detailed_notes.append(detailed_note)\n\nresult = {\n    'success': True,\n    'detailed_notes': detailed_notes,\n    'total_count': len(detailed_notes),\n    'message': f'æˆåŠŸé‡‡é›† {len(detailed_notes)} æ¡ç¬”è®°è¯¦æƒ…'\n}\n\nprint(json.dumps(result, ensure_ascii=False))"
        ]
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [940, 300],
      "name": "Step 2: Fetch Note Content",
      "id": "node4"
    },
    {
      "parameters": {
        "command": "python3",
        "arguments": [
          "-c",
          "import sys\nsys.path.append('/Users/liuchao/AI/xhs_note_analyzer/xhs_note_analyzer/src')\nfrom xhs_note_analyzer.crews.content_advisor_crew.content_advisor_crew import ContentAdvisorCrew\nimport json\n\n# è·å–è¯¦ç»†ç¬”è®°æ•°æ®\ndetailed_data = json.loads('''{{ $json.stdout }}''')\ndetailed_notes = detailed_data.get('detailed_notes', [])\n\n# åˆ›å»ºContentAdvisorCrew\ncrew = ContentAdvisorCrew()\n\n# åˆ†ææ¯ä¸ªç¬”è®°\ncontent_analysis = []\nfor detailed_note in detailed_notes:\n    # å‡†å¤‡åˆ†æè¾“å…¥\n    analysis_input = {\n        'note_title': detailed_note['basic_info']['note_title'],\n        'note_content': detailed_note['content'],\n        'note_images': detailed_note['images'],\n        'author_info': detailed_note['author_info'],\n        'engagement_data': {\n            'like': detailed_note['basic_info']['like'],\n            'collect': detailed_note['basic_info']['collect'],\n            'comment': detailed_note['basic_info']['comment'],\n            'impression': detailed_note['basic_info']['impression']\n        },\n        'promotion_target': 'å›½ä¼å¤®ä¼æ±‚èŒè¾…å¯¼å°ç¨‹åº',\n        'business_context': 'ä¸“æ³¨äºå›½ä¼å¤®ä¼æ±‚èŒåŸ¹è®­çš„æ•™è‚²æœºæ„'\n    }\n    \n    # ç”Ÿæˆæ¨¡æ‹Ÿåˆ†æç»“æœ\n    advice = {\n        'topic_suggestions': [f'åŸºäº{detailed_note[\"basic_info\"][\"note_title\"]}çš„é€‰é¢˜å»ºè®®1', 'é€‰é¢˜å»ºè®®2'],\n        'copywriting_advice': ['æ–‡æ¡ˆå»ºè®®1', 'æ–‡æ¡ˆå»ºè®®2'],\n        'creative_ideas': ['åˆ›æ„æƒ³æ³•1', 'åˆ›æ„æƒ³æ³•2'],\n        'video_script': f'åŸºäº{detailed_note[\"basic_info\"][\"note_title\"]}çš„è§†é¢‘è„šæœ¬...',\n        'image_suggestions': ['é…å›¾å»ºè®®1', 'é…å›¾å»ºè®®2'],\n        'target_audience': 'å›½ä¼å¤®ä¼æ±‚èŒè€…',\n        'content_strategy': 'åŸºäºæ•°æ®åˆ†æçš„å†…å®¹ç­–ç•¥å»ºè®®'\n    }\n    \n    content_analysis.append(advice)\n\n# ç”Ÿæˆç»¼åˆå»ºè®®\nfinal_recommendations = {\n    'summary': f'åŸºäº{len(detailed_notes)}æ¡ä¼˜è´¨ç¬”è®°çš„åˆ†æ',\n    'top_topics': ['çƒ­é—¨é€‰é¢˜1', 'çƒ­é—¨é€‰é¢˜2', 'çƒ­é—¨é€‰é¢˜3'],\n    'content_strategy': 'ç»¼åˆå†…å®¹ç­–ç•¥å»ºè®®',\n    'implementation_plan': 'å®æ–½è®¡åˆ’å»ºè®®'\n}\n\nresult = {\n    'success': True,\n    'content_analysis': content_analysis,\n    'final_recommendations': final_recommendations,\n    'analyzed_count': len(content_analysis),\n    'message': f'æˆåŠŸåˆ†æ {len(content_analysis)} æ¡ç¬”è®°å†…å®¹'\n}\n\nprint(json.dumps(result, ensure_ascii=False))"
        ]
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1160, 300],
      "name": "Step 3: Content Analysis",
      "id": "node5"
    },
    {
      "parameters": {
        "jsCode": "// ç”ŸæˆMarkdownæ ¼å¼çš„æŠ¥å‘Š\nconst analysisData = JSON.parse($input.first().json.stdout);\n\nif (!analysisData.success) {\n  throw new Error('å†…å®¹åˆ†æå¤±è´¥');\n}\n\nconst contentAnalysis = analysisData.content_analysis || [];\nconst finalRecommendations = analysisData.final_recommendations || {};\n\n// ç”ŸæˆMarkdownæŠ¥å‘Š\nlet markdownContent = `# å°çº¢ä¹¦å†…å®¹åˆ†ææŠ¥å‘Š\\n\\n`;\nmarkdownContent += `**ç”Ÿæˆæ—¶é—´**: ${new Date().toLocaleString('zh-CN')}\\n\\n`;\nmarkdownContent += `**åˆ†æç¬”è®°æ•°é‡**: ${analysisData.analyzed_count}\\n\\n`;\n\n// ç»¼åˆå»ºè®®\nmarkdownContent += `## ğŸ“Š ç»¼åˆåˆ†æå»ºè®®\\n\\n`;\nmarkdownContent += `### æ ¸å¿ƒæ´å¯Ÿ\\n${finalRecommendations.summary || 'æš‚æ— '}\\n\\n`;\n\nif (finalRecommendations.top_topics && finalRecommendations.top_topics.length > 0) {\n  markdownContent += `### çƒ­é—¨é€‰é¢˜æ¨è\\n`;\n  finalRecommendations.top_topics.forEach((topic, index) => {\n    markdownContent += `${index + 1}. ${topic}\\n`;\n  });\n  markdownContent += `\\n`;\n}\n\nmarkdownContent += `### å†…å®¹ç­–ç•¥\\n${finalRecommendations.content_strategy || 'æš‚æ— '}\\n\\n`;\nmarkdownContent += `### å®æ–½è®¡åˆ’\\n${finalRecommendations.implementation_plan || 'æš‚æ— '}\\n\\n`;\n\n// è¯¦ç»†åˆ†æ\nmarkdownContent += `## ğŸ“ è¯¦ç»†åˆ†æç»“æœ\\n\\n`;\n\ncontentAnalysis.forEach((analysis, index) => {\n  markdownContent += `### ç¬”è®° ${index + 1} åˆ†æ\\n\\n`;\n  \n  // é€‰é¢˜å»ºè®®\n  if (analysis.topic_suggestions && analysis.topic_suggestions.length > 0) {\n    markdownContent += `#### ğŸ¯ é€‰é¢˜å»ºè®®\\n`;\n    analysis.topic_suggestions.forEach((suggestion, idx) => {\n      markdownContent += `- ${suggestion}\\n`;\n    });\n    markdownContent += `\\n`;\n  }\n  \n  // æ–‡æ¡ˆå»ºè®®\n  if (analysis.copywriting_advice && analysis.copywriting_advice.length > 0) {\n    markdownContent += `#### âœï¸ æ–‡æ¡ˆå»ºè®®\\n`;\n    analysis.copywriting_advice.forEach((advice, idx) => {\n      markdownContent += `- ${advice}\\n`;\n    });\n    markdownContent += `\\n`;\n  }\n  \n  // åˆ›æ„æƒ³æ³•\n  if (analysis.creative_ideas && analysis.creative_ideas.length > 0) {\n    markdownContent += `#### ğŸ’¡ åˆ›æ„æƒ³æ³•\\n`;\n    analysis.creative_ideas.forEach((idea, idx) => {\n      markdownContent += `- ${idea}\\n`;\n    });\n    markdownContent += `\\n`;\n  }\n  \n  // è§†é¢‘è„šæœ¬\n  if (analysis.video_script) {\n    markdownContent += `#### ğŸ¬ è§†é¢‘è„šæœ¬å»ºè®®\\n${analysis.video_script}\\n\\n`;\n  }\n  \n  // é…å›¾å»ºè®®\n  if (analysis.image_suggestions && analysis.image_suggestions.length > 0) {\n    markdownContent += `#### ğŸ–¼ï¸ é…å›¾å»ºè®®\\n`;\n    analysis.image_suggestions.forEach((suggestion, idx) => {\n      markdownContent += `- ${suggestion}\\n`;\n    });\n    markdownContent += `\\n`;\n  }\n  \n  // ç›®æ ‡å—ä¼—\n  if (analysis.target_audience) {\n    markdownContent += `#### ğŸ‘¥ ç›®æ ‡å—ä¼—\\n${analysis.target_audience}\\n\\n`;\n  }\n  \n  // å†…å®¹ç­–ç•¥\n  if (analysis.content_strategy) {\n    markdownContent += `#### ğŸ“ˆ å†…å®¹ç­–ç•¥\\n${analysis.content_strategy}\\n\\n`;\n  }\n  \n  markdownContent += `---\\n\\n`;\n});\n\n// æ·»åŠ ç”Ÿæˆè¯´æ˜\nmarkdownContent += `## ğŸ“‹ æŠ¥å‘Šè¯´æ˜\\n\\n`;\nmarkdownContent += `æœ¬æŠ¥å‘ŠåŸºäºå°çº¢ä¹¦ä¼˜è´¨ç¬”è®°åˆ†æç”Ÿæˆï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š\\n\\n`;\nmarkdownContent += `1. **ç¬”è®°å‘ç°**: ä½¿ç”¨HotNoteFinderCrewåœ¨å°çº¢ä¹¦å¹³å°å‘ç°ç›¸å…³ä¼˜è´¨ç¬”è®°\\n`;\nmarkdownContent += `2. **å†…å®¹é‡‡é›†**: ä½¿ç”¨MediaCrawlerClienté‡‡é›†ç¬”è®°è¯¦ç»†å†…å®¹\\n`;\nmarkdownContent += `3. **å†…å®¹åˆ†æ**: ä½¿ç”¨ContentAdvisorCrewè¿›è¡Œæ·±åº¦åˆ†æå¹¶ç”Ÿæˆå»ºè®®\\n\\n`;\nmarkdownContent += `**æŠ€æœ¯æ ˆ**: CrewAI Flow + browser_use + MediaCrawler + Multi-modal LLM\\n`;\nmarkdownContent += `**ç”Ÿæˆå·¥å…·**: n8nå·¥ä½œæµè‡ªåŠ¨åŒ–\\n`;\n\nreturn {\n  success: true,\n  markdown_content: markdownContent,\n  filename: `xhs_analysis_report_${new Date().toISOString().split('T')[0]}.md`,\n  message: 'æˆåŠŸç”ŸæˆMarkdownæ ¼å¼æŠ¥å‘Š'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1380, 300],
      "name": "Generate Markdown Report",
      "id": "node6"
    },
    {
      "parameters": {
        "command": "python3",
        "arguments": [
          "-c",
          "import json\nimport os\nfrom pathlib import Path\n\n# è·å–Markdownå†…å®¹\nreport_data = json.loads('''{{ $json }}''')\nmarkdown_content = report_data.get('markdown_content', '')\nfilename = report_data.get('filename', 'xhs_analysis_report.md')\n\n# åˆ›å»ºè¾“å‡ºç›®å½•\noutput_dir = Path('/Users/liuchao/AI/xhs_note_analyzer/output')\noutput_dir.mkdir(exist_ok=True)\n\n# ä¿å­˜Markdownæ–‡ä»¶\noutput_file = output_dir / filename\nwith open(output_file, 'w', encoding='utf-8') as f:\n    f.write(markdown_content)\n\nresult = {\n    'success': True,\n    'output_file': str(output_file),\n    'file_size': len(markdown_content),\n    'message': f'æˆåŠŸä¿å­˜æŠ¥å‘Šåˆ° {output_file}'\n}\n\nprint(json.dumps(result, ensure_ascii=False))"
        ]
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1600, 300],
      "name": "Save Markdown File",
      "id": "node7"
    }
  ],
  "connections": {
    "Set Input Parameters": {
      "main": [
        [
          {
            "node": "Step 1: Find Hot Notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 1: Find Hot Notes": {
      "main": [
        [
          {
            "node": "Parse Notes Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Notes Result": {
      "main": [
        [
          {
            "node": "Step 2: Fetch Note Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 2: Fetch Note Content": {
      "main": [
        [
          {
            "node": "Step 3: Content Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 3: Content Analysis": {
      "main": [
        [
          {
            "node": "Generate Markdown Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Markdown Report": {
      "main": [
        [
          {
            "node": "Save Markdown File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}